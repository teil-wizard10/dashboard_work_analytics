<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workforce Analytics Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles for dark theme and gradients */
        body {
            font-family: "Inter", sans-serif;
            /*background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);  Dark gradient background */
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0; /* Light text color */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            flex-grow: 1;
        }
        .card {
            background: rgba(40, 40, 70, 0.6); /* Slightly lighter dark background for cards */
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px; /* Fixed height for charts, adjust as needed */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: rgba(0, 0, 0, 0.8);
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            color: white;
            z-index: 1000;
        }
        .axis path,
        .axis line {
            stroke: #a0a0a0;
        }
        .axis text {
            fill: #e0e0e0;
        }
        .grid line {
            stroke: #555;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }
        .domain {
            stroke: #a0a0a0;
        }
        .bar:hover {
            opacity: 0.8;
            cursor: pointer;
        }
        .back-button {
            background-color: #6a0dad; /* Electric Violet */
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 1rem;
            display: none; /* Hidden by default */
        }
        .back-button:hover {
            background-color: #8a2be2;
        }


        /* Additional */

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #14b8a6, #db2777, #8b5cf6, #0ea5e9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header p {
            font-size: 1.2rem;
            color: #a1a1aa;
            margin-bottom: 10px;
        }
        
        .card-header {
            background: rgba(40, 40, 70, 0.6); /* Slightly lighter dark background for cards */
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }


    </style>
</head>
<body class="antialiased">
    <div class="container">
        <!-- Header Section -->
         
        <!-- 
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-turquoise-400 via-deep-pink-500 to-electric-violet-600 mb-4">
                Workforce Analytics Dashboard
            </h1>
            <p class="text-lg text-gray-300 mb-4">
                A comprehensive overview of employee data, satisfaction, and productivity.
            </p>
            <p class="text-sm text-gray-400">
                Developed by the Data Insights Team
            </p>
        </header>
        -->

        <div class="header text-center card-header">
            <h1>Work Analytics Dashboard</h1>
            <p>Comprehensive analysis of employee data, performance metrics, and workplace insights</p>
            <div class="team-info">Developed by the Data Analytics Team: Francisco Chan, Alan Mendoza, Emmanuel Carmona, Rogelio Novelo, Carlos Helguera, and Daniel Herrera</div>
        </div>


        <!-- Filters Section -->
        <section class="mb-8 p-4 card">

            <h2 class="text-2xl font-bold mb-4 bg-clip-text bg-gradient-to-r from-azure-400 to-turquoise-400">Filters</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div>
                    <label for="department-filter" class="block text-sm font-medium text-gray-300">Department</label>
                    <select id="department-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-azure-500 focus:border-azure-500 sm:text-sm rounded-md">
                        <option value="all">All</option>
                    </select>
                </div>
                <div>
                    <label for="zone-filter" class="block text-sm font-medium text-gray-300">Geographic Zone</label>
                    <select id="zone-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-azure-500 focus:border-azure-500 sm:text-sm rounded-md">
                        <option value="all">All</option>
                    </select>
                </div>
                <div>
                    <label for="gender-filter" class="block text-sm font-medium text-gray-300">Gender</label>
                    <select id="gender-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-azure-500 focus:border-azure-500 sm:text-sm rounded-md">
                        <option value="all">All</option>
                    </select>
                </div>
                <div>
                    <label for="education-filter" class="block text-sm font-medium text-gray-300">Education Level</label>
                    <select id="education-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-azure-500 focus:border-azure-500 sm:text-sm rounded-md">
                        <option value="all">All</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- KPI Cards Section -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-electric-violet-400 to-deep-pink-400">Key Performance Indicators</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card flex flex-col items-center justify-center text-center">
                    <p class="text-sm text-gray-400">Total Employees</p>
                    <p id="kpi-total-employees" class="text-4xl font-bold text-turquoise-300 mt-2">0</p>
                </div>
                <div class="card flex flex-col items-center justify-center text-center">
                    <p class="text-sm text-gray-400">Average Annual Salary</p>
                    <p id="kpi-avg-salary" class="text-4xl font-bold text-deep-pink-300 mt-2">$0</p>
                </div>
                <div class="card flex flex-col items-center justify-center text-center">
                    <p class="text-sm text-gray-400">Avgerage Weekly Work Hours</p>
                    <p id="kpi-avg-work-hours" class="text-4xl font-bold text-electric-violet-300 mt-2">0</p>
                </div>
                <div class="card flex flex-col items-center justify-center text-center">
                    <p class="text-sm text-gray-400">Avgerage Job Satisfaction</p>
                    <p id="kpi-avg-satisfaction" class="text-4xl font-bold text-azure-300 mt-2">0</p>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Scatter Plot -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4 bg-clip-text bg-gradient-to-r from-turquoise-400 to-azure-400">Job Satisfaction vs. Annual Salary (by Gender)</h3>
                <div id="scatter-plot" class="chart-container"></div>
            </div>

            <!-- Correlation Matrix -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4 bg-clip-text bg-gradient-to-r from-deep-pink-400 to-electric-violet-400">Correlation Matrix of Numeric Metrics</h3>
                <div id="correlation-matrix" class="chart-container"></div>
            </div>

            <!-- Box Plot -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4 bg-clip-text bg-gradient-to-r from-electric-violet-400 to-turquoise-400">Annual Salary Distribution by Department</h3>
                <div id="box-plot" class="chart-container"></div>
            </div>

            <!-- Pie Chart -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4 bg-clip-text bg-gradient-to-r from-azure-400 to-deep-pink-400">Work Modality Distribution</h3>
                <div id="pie-chart" class="chart-container"></div>
            </div>

            <!-- Bar Chart with Drill-down -->
            <div class="card lg:col-span-2">
                <h3 class="text-xl font-bold mb-4 bg-clip-text bg-gradient-to-r from-deep-pink-400 to-azure-400">Average Annual Salary by Geographic Zone / City</h3>
                <button id="back-button" class="back-button">← Back to Zones</button>
                <div id="bar-chart-drilldown" class="chart-container"></div>
            </div>
        </section>
    </div>

    <script>
        // Global variables
        let rawData = [];
        let filteredData = [];
        let currentDrilldownZone = null; // For the drill-down chart

        // Dimensions for charts (common margins)
        const margin = { top: 30, right: 30, bottom: 80, left: 80 }; // Increased bottom for labels
        let width, height;

        // Tooltip element
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Function to update dimensions based on parent container
        function updateChartDimensions(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                width = container.clientWidth - margin.left - margin.right;
                height = container.clientHeight - margin.top - margin.bottom;
            }
        }

        // --- Data Loading and Preprocessing ---
        d3.csv("work.csv").then(data => {
            rawData = data.map(d => {
                // Parse numeric columns
                d.edad = +d.edad;
                d.experiencia_anos = +d.experiencia_anos;
                d.num_hijos = +d.num_hijos;
                d.salario_anual = +d.salario_anual;
                d.horas_semanales = +d.horas_semanales;
                d.horas_ejercicio_semana = +d.horas_ejercicio_semana;
                d.horas_videojuegos_semana = +d.horas_videojuegos_semana;
                d.horas_ocio_semana = +d.horas_ocio_semana;
                d.horas_sueno_noche = +d.horas_sueno_noche;
                d.nivel_estres = +d.nivel_estres;
                d.satisfaccion_laboral = +d.satisfaccion_laboral;
                d.productividad_score = +d.productividad_score;
                d.dias_vacaciones = +d.dias_vacaciones;
                d.capacitaciones_ano = +d.capacitaciones_ano;
                return d;
            });

            filteredData = [...rawData]; // Initialize filtered data

            populateFilters();
            updateDashboard();

            // Add event listeners for filters
            d3.select("#department-filter").on("change", updateFilters);
            d3.select("#zone-filter").on("change", updateFilters);
            d3.select("#gender-filter").on("change", updateFilters);
            d3.select("#education-filter").on("change", updateFilters);

            // Handle window resize
            window.addEventListener('resize', () => {
                updateDashboard();
            });

        }).catch(error => {
            console.error("Error loading the CSV file:", error);
            // Display a user-friendly message in the dashboard if CSV fails to load
            d3.select(".container").append("div")
                .attr("class", "text-red-500 text-center mt-8")
                .text("Error: Could not load data. Please ensure 'work.csv' is in the same directory.");
        });

        // --- Filter Population ---
        function populateFilters() {
            const departments = [...new Set(rawData.map(d => d.departamento))].sort();
            const zones = [...new Set(rawData.map(d => d.zona_geografica))].sort();
            const genders = [...new Set(rawData.map(d => d.genero))].sort();
            const educationLevels = [...new Set(rawData.map(d => d.nivel_educacion))].sort();

            d3.select("#department-filter").selectAll("option.dynamic")
                .data(departments)
                .enter().append("option")
                .attr("class", "dynamic")
                .attr("value", d => d)
                .text(d => d);

            d3.select("#zone-filter").selectAll("option.dynamic")
                .data(zones)
                .enter().append("option")
                .attr("class", "dynamic")
                .attr("value", d => d)
                .text(d => d);

            d3.select("#gender-filter").selectAll("option.dynamic")
                .data(genders)
                .enter().append("option")
                .attr("class", "dynamic")
                .attr("value", d => d)
                .text(d => d);

            d3.select("#education-filter").selectAll("option.dynamic")
                .data(educationLevels)
                .enter().append("option")
                .attr("class", "dynamic")
                .attr("value", d => d)
                .text(d => d);
        }

        // --- Filter Update Logic ---
        function updateFilters() {
            const selectedDepartment = d3.select("#department-filter").property("value");
            const selectedZone = d3.select("#zone-filter").property("value");
            const selectedGender = d3.select("#gender-filter").property("value");
            const selectedEducation = d3.select("#education-filter").property("value");

            filteredData = rawData.filter(d => {
                return (selectedDepartment === "all" || d.departamento === selectedDepartment) &&
                       (selectedZone === "all" || d.zona_geografica === selectedZone) &&
                       (selectedGender === "all" || d.genero === selectedGender) &&
                       (selectedEducation === "all" || d.nivel_educacion === selectedEducation);
            });

            // Reset drilldown when filters change
            currentDrilldownZone = null;
            d3.select("#back-button").style("display", "none");

            updateDashboard();
        }

        // --- Main Update Function ---
        function updateDashboard() {
            updateKPIs(filteredData);
            drawScatterPlot(filteredData);
            drawCorrelationMatrix(filteredData);
            drawBoxPlot(filteredData);
            drawPieChart(filteredData);
            drawBarChartDrilldown(filteredData);
        }

        // --- KPI Cards Update ---
        function updateKPIs(data) {
            const totalEmployees = data.length;
            const avgSalary = d3.mean(data, d => d.salario_anual);
            const avgWorkHours = d3.mean(data, d => d.horas_semanales);
            const avgSatisfaction = d3.mean(data, d => d.satisfaccion_laboral);

            d3.select("#kpi-total-employees").text(totalEmployees);
            d3.select("#kpi-avg-salary").text(`$${avgSalary ? avgSalary.toFixed(2) : 'N/A'}`);
            d3.select("#kpi-avg-work-hours").text(avgWorkHours ? avgWorkHours.toFixed(1) : 'N/A');
            d3.select("#kpi-avg-satisfaction").text(avgSatisfaction ? avgSatisfaction.toFixed(2) : 'N/A');
        }

        // --- Scatter Plot ---
        function drawScatterPlot(data) {
            updateChartDimensions("scatter-plot");
            d3.select("#scatter-plot svg").remove();

            if (width <= 0 || height <= 0) return; // Prevent drawing if dimensions are invalid

            const svg = d3.select("#scatter-plot").append("svg")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.salario_anual)).nice()
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.satisfaccion_laboral)).nice()
                .range([height, 0]);

            const colorScale = d3.scaleOrdinal()
                .domain([...new Set(data.map(d => d.genero))])
                .range(["#4ade80", "#f472b6", "#60a5fa", "#facc15"]); // Green, Pink, Blue, Yellow for genders

            // Add X axis
            svg.append("g")
                .attr("class", "axis x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format("$,.0f")));

            // Add Y axis
            svg.append("g")
                .attr("class", "axis y-axis")
                .call(d3.axisLeft(yScale));

            // Add X axis label
            svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 20)
                .style("fill", "#e0e0e0")
                .text("Annual Salary");

            // Add Y axis label
            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .attr("transform", "rotate(-90)")
                .style("fill", "#e0e0e0")
                .text("Job Satisfaction Score");

            // Add dots
            svg.selectAll("dot")
                .data(data)
                .enter().append("circle")
                .attr("cx", d => xScale(d.salario_anual))
                .attr("cy", d => yScale(d.satisfaccion_laboral))
                .attr("r", 5)
                .style("fill", d => colorScale(d.genero))
                .style("opacity", 0.7)
                .attr("stroke", "#333")
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Salary: $${d.salario_anual.toLocaleString()}<br/>Satisfaction: ${d.satisfaccion_laboral}<br/>Gender: ${d.genero}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add a simple legend
            const legend = svg.selectAll(".legend")
                .data(colorScale.domain())
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(0,${i * 20})`);

            legend.append("rect")
                .attr("x", width - 18)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", colorScale);

            legend.append("text")
                .attr("x", width - 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "end")
                .style("fill", "#e0e0e0")
                .text(d => d);
        }

        // --- Correlation Matrix ---
        function drawCorrelationMatrix(data) {
            updateChartDimensions("correlation-matrix");
            d3.select("#correlation-matrix svg").remove();

            if (width <= 0 || height <= 0) return;

            const numericCols = [
                "salario_anual", "satisfaccion_laboral", "productividad_score",
                "nivel_estres", "edad", "experiencia_anos", "num_hijos",
                "horas_semanales", "horas_ejercicio_semana", "horas_videojuegos_semana",
                "horas_ocio_semana", "horas_sueno_noche", "dias_vacaciones", "capacitaciones_ano"
            ];

            // Filter out columns that might not exist in the data or have no numeric values
            const availableNumericCols = numericCols.filter(col => data.some(d => typeof d[col] === 'number' && !isNaN(d[col])));

            // Calculate correlation matrix
            const correlationMatrix = [];
            for (let i = 0; i < availableNumericCols.length; i++) {
                correlationMatrix[i] = [];
                for (let j = 0; j < availableNumericCols.length; j++) {
                    const x = data.map(d => d[availableNumericCols[i]]);
                    const y = data.map(d => d[availableNumericCols[j]]);
                    correlationMatrix[i][j] = calculatePearsonCorrelation(x, y);
                }
            }

            const svg = d3.select("#correlation-matrix").append("svg")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(availableNumericCols)
                .padding(0.01);

            const y = d3.scaleBand()
                .range([height, 0])
                .domain(availableNumericCols)
                .padding(0.01);

            const colorScale = d3.scaleLinear()
                .range(["#f0f8ff", "#6a0dad", "#ff1493"]) // Light blue, Violet, Deep Pink
                .domain([-1, 0, 1]);

            svg.selectAll()
                .data(correlationMatrix.flat())
                .enter().append("rect")
                .attr("x", (d, i) => x(availableNumericCols[i % availableNumericCols.length]))
                .attr("y", (d, i) => y(availableNumericCols[Math.floor(i / availableNumericCols.length)]))
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", d => colorScale(d))
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Correlation: ${d.toFixed(2)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add the X Axis
            svg.append("g")
                .attr("class", "axis x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Add the Y Axis
            svg.append("g")
                .attr("class", "axis y-axis")
                .call(d3.axisLeft(y));

            // Correlation calculation function (Pearson)
            function calculatePearsonCorrelation(x, y) {
                const n = x.length;
                if (n === 0) return 0; // Handle empty arrays

                // Filter out NaN values and ensure both arrays have corresponding valid numbers
                const validPairs = [];
                for (let i = 0; i < n; i++) {
                    if (typeof x[i] === 'number' && !isNaN(x[i]) && typeof y[i] === 'number' && !isNaN(y[i])) {
                        validPairs.push({ x: x[i], y: y[i] });
                    }
                }

                if (validPairs.length < 2) return 0; // Need at least 2 data points for correlation

                const sumX = d3.sum(validPairs, p => p.x);
                const sumY = d3.sum(validPairs, p => p.y);
                const sumXY = d3.sum(validPairs, p => p.x * p.y);
                const sumX2 = d3.sum(validPairs, p => p.x * p.x);
                const sumY2 = d3.sum(validPairs, p => p.y * p.y);
                const N = validPairs.length;

                const numerator = N * sumXY - sumX * sumY;
                const denominator = Math.sqrt((N * sumX2 - sumX * sumX) * (N * sumY2 - sumY * sumY));

                if (denominator === 0) return 0; // Avoid division by zero
                return numerator / denominator;
            }
        }

        // --- Box Plot ---
        function drawBoxPlot(data) {
            updateChartDimensions("box-plot");
            d3.select("#box-plot svg").remove();

            if (width <= 0 || height <= 0) return;

            const svg = d3.select("#box-plot").append("svg")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Group data by department
            const departments = [...new Set(data.map(d => d.departamento))];
            const dataGrouped = d3.group(data, d => d.departamento);

            const boxPlotData = [];
            departments.forEach(dept => {
                const salaries = dataGrouped.get(dept).map(d => d.salario_anual).sort(d3.ascending);
                if (salaries.length === 0) return;

                const q1 = d3.quantile(salaries, 0.25);
                const median = d3.quantile(salaries, 0.5);
                const q3 = d3.quantile(salaries, 0.75);
                const iqr = q3 - q1;
                const min = d3.max([d3.min(salaries), q1 - 1.5 * iqr]);
                const max = d3.min([d3.max(salaries), q3 + 1.5 * iqr]);

                boxPlotData.push({
                    department: dept,
                    q1: q1,
                    median: median,
                    q3: q3,
                    min: min,
                    max: max,
                    outliers: salaries.filter(s => s < min || s > max)
                });
            });

            const xScale = d3.scaleBand()
                .range([0, width])
                .domain(boxPlotData.map(d => d.department))
                .paddingInner(1)
                .paddingOuter(0.5);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.salario_anual) * 1.1]).nice()
                .range([height, 0]);

            // X axis
            svg.append("g")
                .attr("class", "axis x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");
            
            svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .style("fill", "#e0e0e0")
                .text("Department");

            // Y axis
            svg.append("g")
                .attr("class", "axis y-axis")
                .call(d3.axisLeft(yScale).tickFormat(d3.format("$,.0f")));

            // Y axis label
            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .attr("transform", "rotate(-90)")
                .style("fill", "#e0e0e0")
                .text("Annual Salary");

            // Show the main vertical line
            svg.selectAll("vertLines")
                .data(boxPlotData)
                .enter()
                .append("line")
                .attr("x1", d => xScale(d.department))
                .attr("x2", d => xScale(d.department))
                .attr("y1", d => yScale(d.min))
                .attr("y2", d => yScale(d.max))
                .attr("stroke", "#a0a0a0")
                .style("stroke-width", 1);

            // Show the boxes
            const boxWidth = 50;
            svg.selectAll("boxes")
                .data(boxPlotData)
                .enter()
                .append("rect")
                .attr("x", d => xScale(d.department) - boxWidth / 2)
                .attr("y", d => yScale(d.q3))
                .attr("height", d => yScale(d.q1) - yScale(d.q3))
                .attr("width", boxWidth)
                .attr("stroke", "#a0a0a0")
                .style("fill", "rgba(106, 13, 173, 0.4)") /* Electric Violet with transparency */
                .style("stroke-width", 1);

            // Show the median
            svg.selectAll("medianLines")
                .data(boxPlotData)
                .enter()
                .append("line")
                .attr("x1", d => xScale(d.department) - boxWidth / 2)
                .attr("x2", d => xScale(d.department) + boxWidth / 2)
                .attr("y1", d => yScale(d.median))
                .attr("y2", d => yScale(d.median))
                .attr("stroke", "#ff1493") /* Deep Pink for median */
                .style("stroke-width", 2);

            // Show outliers
            svg.selectAll("outliers")
                .data(boxPlotData)
                .enter()
                .append("g")
                .selectAll("circle")
                .data(d => d.outliers.map(o => ({ department: d.department, value: o })))
                .enter()
                .append("circle")
                .attr("cx", d => xScale(d.department))
                .attr("cy", d => yScale(d.value))
                .attr("r", 4)
                .style("fill", "#4ade80") /* Turquoise for outliers */
                .attr("stroke", "#333")
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Department: ${d.department}<br/>Outlier Salary: $${d.value.toLocaleString()}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }

        // --- Pie Chart ---
        function drawPieChart(data) {
            updateChartDimensions("pie-chart");
            d3.select("#pie-chart svg").remove();

            if (width <= 0 || height <= 0) return;

            const radius = Math.min(width, height) / 2;

            const svg = d3.select("#pie-chart").append("svg")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${width / 2 + margin.left},${height / 2 + margin.top})`);

            // Count occurrences of each work modality
            const modalityCounts = d3.rollup(data, v => v.length, d => d.modalidad_trabajo);
            const pieData = Array.from(modalityCounts, ([key, value]) => ({ modality: key, count: value }));

            const pie = d3.pie()
                .value(d => d.count)
                .sort(null); // No sorting, use original order

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            const outerArc = d3.arc()
                .innerRadius(radius * 0.9)
                .outerRadius(radius * 0.9);

            const colorScale = d3.scaleOrdinal()
                .domain(pieData.map(d => d.modality))
                .range(["#4ade80", "#f472b6", "#60a5fa", "#facc15", "#8b5cf6"]); // Turquoise, Deep Pink, Azure, Yellow, Violet

            // Build the pie chart
            svg.selectAll('slices')
                .data(pie(pieData))
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', d => colorScale(d.data.modality))
                .attr("stroke", "#333")
                .style("stroke-width", "1px")
                .style("opacity", 0.8)
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`${d.data.modality}: ${d.data.count} (${(d.data.count / data.length * 100).toFixed(1)}%)`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add labels
            svg.selectAll('polyline')
                .data(pie(pieData))
                .enter()
                .append('polyline')
                .attr("stroke", "#a0a0a0")
                .style("fill", "none")
                .attr("stroke-width", 1)
                .attr('points', d => {
                    const posA = arc.centroid(d); // centroid of arc
                    const posB = outerArc.centroid(d); // centroid of outer arc
                    const posC = outerArc.centroid(d); // end of polyline
                    const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1); // x position of text
                    return [posA, posB, posC];
                });

            svg.selectAll('text')
                .data(pie(pieData))
                .enter()
                .append('text')
                .text(d => `${d.data.modality} (${(d.data.count / data.length * 100).toFixed(1)}%)`)
                .attr('transform', d => {
                    const pos = outerArc.centroid(d);
                    const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    pos[0] = radius * 1.05 * (midangle < Math.PI ? 1 : -1);
                    return `translate(${pos})`;
                })
                .style('text-anchor', d => {
                    const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    return (midangle < Math.PI ? 'start' : 'end');
                })
                .style("fill", "#e0e0e0")
                .style("font-size", "12px");
        }

        // --- Bar Chart with Drill-down ---
        function drawBarChartDrilldown(data) {
            updateChartDimensions("bar-chart-drilldown");
            d3.select("#bar-chart-drilldown svg").remove();

            if (width <= 0 || height <= 0) return;

            const svg = d3.select("#bar-chart-drilldown").append("svg")
                .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            let displayData;
            let xDomain;
            let xAxisLabel;

            if (currentDrilldownZone) {
                // Drill-down view: cities within a specific zone
                displayData = d3.rollup(
                    data.filter(d => d.zona_geografica === currentDrilldownZone),
                    v => d3.mean(v, d => d.salario_anual),
                    d => d.ciudad
                );
                xDomain = [...displayData.keys()].sort();
                xAxisLabel = `Cities in ${currentDrilldownZone}`;
                d3.select("#back-button").style("display", "block");
            } else {
                // Initial view: geographic zones
                displayData = d3.rollup(
                    data,
                    v => d3.mean(v, d => d.salario_anual),
                    d => d.zona_geografica
                );
                xDomain = [...displayData.keys()].sort();
                xAxisLabel = "Geographic Zone";
                d3.select("#back-button").style("display", "none");
            }

            const chartData = Array.from(displayData, ([key, value]) => ({ label: key, value: value }));

            const xScale = d3.scaleBand()
                .range([0, width])
                .domain(xDomain)
                .padding(0.2);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(chartData, d => d.value) * 1.1]).nice()
                .range([height, 0]);

            // Add X axis
            svg.append("g")
                .attr("class", "axis x-axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Add Y axis
            svg.append("g")
                .attr("class", "axis y-axis")
                .call(d3.axisLeft(yScale).tickFormat(d3.format("$,.0f")));

            // Add X axis label
            svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 20)
                .style("fill", "#e0e0e0")
                .text(xAxisLabel);

            // Add Y axis label
            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("y", -margin.left + 20)
                .attr("x", -height / 2)
                .attr("transform", "rotate(-90)")
                .style("fill", "#e0e0e0")
                .text("Average Annual Salary");

            // Bars
            svg.selectAll(".bar")
                .data(chartData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => xScale(d.label))
                .attr("y", d => yScale(d.value))
                .attr("width", xScale.bandwidth())
                .attr("height", d => height - yScale(d.value))
                .attr("fill", "#60a5fa") /* Azure Blue */
                .on("click", (event, d) => {
                    if (!currentDrilldownZone) { // Only drill down if not already in drilldown mode
                        currentDrilldownZone = d.label;
                        drawBarChartDrilldown(filteredData); // Redraw with filtered data
                    }
                })
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`${d.label}: $${d.value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Back button functionality
            d3.select("#back-button").on("click", () => {
                currentDrilldownZone = null;
                drawBarChartDrilldown(filteredData);
            });
        }
    </script>
</body>
</html>